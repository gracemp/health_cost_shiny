{
    "collab_server" : "",
    "contents" : "###Healthcost in R shiny, a first attempt. \n\nlibrary(shiny)\nlibrary(dplyr)\nlibrary(stringr)\n\n\n###reading in the engine tables as CSVs-- will eventually need to do this as RData and save it to the app\ndiabetes_engine<-read.csv('~/Health_cost_shiny/diabetes_engine.csv',row.names = 1)\n\n###Pre-made DFs--- different populations based on either Baltimore or King County\nbmore_hispanic_male<-c(7136,2581,617)\nbmore_white_male<-c(32524,23217,16118)\nbmore_black_male<-c(48728,50085,24806)\nbmore_asian_male<-c(4120,1188,553)\nbmore_hispanic_female<-c(5353,1824,614)\nbmore_white_female<-c(33886,21421,20388)\nbmore_black_female<-c(58231,60778,38939)\nbmore_asian_female<-c(4415,1215,707)\n\nbmore_DF<-cbind.data.frame(bmore_hispanic_male,bmore_white_male,bmore_black_male,bmore_asian_male,bmore_hispanic_female,bmore_white_female,bmore_black_female,bmore_asian_female)\ncolnames(bmore_DF)<-c(\"Hispanic Male\",\"White Male\",\"Black Male\",\"Asian Male\",\"Hispanic Female\",\"White Female\",\"Black Female\",\"Asian Female\")\nrownames(bmore_DF)<-c(\"20-39\",\"40-59\",\"60+\")\n\nKC_hispanic_male<-c(86085,54076,24091)\nKC_white_male<-c(147324,102038,77782)\nKC_black_male<-c(109342,97695,50953)\nKC_asian_male<-c(41807,36916,16303)\nKC_hispanic_female<-c(81337,61774,35580)\nKC_white_female<-c(147654,102984,105808)\nKC_black_female<-c(138645,138595,86475)\nKC_asian_female<-c(46692,37741,17626)\n\nKC_DF<-cbind.data.frame(KC_hispanic_male,KC_white_male,KC_black_male,KC_asian_male,KC_hispanic_female,KC_white_female,KC_black_female,KC_asian_female)\ncolnames(KC_DF)<-c(\"Hispanic Male\",\"White Male\",\"Black Male\",\"Asian Male\",\"Hispanic Female\",\"White Female\",\"Black Female\",\"Asian Female\")\nrownames(KC_DF)<-c(\"20-39\",\"40-59\",\"60+\")\n\n#Eventually will have to write a function that takes user inputs to create a custom population or imports from SAS/CSV (csv should be fairly easy if it's in this format...)\n#Possible Grace ask--- interactive formula that takes a total population and the % of minorities of each (slider input?) and then spits out a working DF in our format\n\n###Function that takes the initial population and gives a huge list which can be sorted out to make seperate DFs, using diabetes engine... if hypertension engine is in the same format then just modify this to accept disease type as a argument\nhealthcost_values_diabetes<-function(population,pop_estimate){\n  ##creating the tables that are on the Engine-Diabetes tab\n  #doing the multiplication and assigning\n  \n  ##First way of doing it\n  # if(pop_estimate==\"base\"){\n  #   for(i in 1:8){\n  # column_i<-c()\n  #     for(j in 1:3){\n  #   column_i<-append(column_i,(population[j,i]*diabetes_engine[((i*3)-(3-j)),1])) #omg that took me forever to figure out but it should create all of our columns for all the seperate tables\n  #     }\n  # calculated_df[,i]<-(column_i)\n  #   }\n  \n  ##New Way\n  if(pop_estimate==\"base\"){\n    pop_estimate_list<-c()\n    for(i in 1:8){\n      for(j in 1:3){\n        pop_estimate_list<-append(pop_estimate_list,(population[j,i]*diabetes_engine[((i*3)-(3-j)),1]))\n        pop_estimate_list<-append(pop_estimate_list,(population[j,i]*diabetes_engine[((i*3)-(3-j)),2]))\n        pop_estimate_list<-append(pop_estimate_list,(population[j,i]*diabetes_engine[((i*3)-(3-j)),3]))\n        pop_estimate_list<-append(pop_estimate_list,(population[j,i]*diabetes_engine[((i*3)-(3-j)),4]))\n      }\n    }\n  }else if(pop_estimate==\"high\"){\n    pop_estimate_list<-c()\n    for(i in 1:8){\n      for(j in 1:3){\n        pop_estimate_list<-append(pop_estimate_list,(population[j,i]*diabetes_engine[((i*3)-(3-j)),5]))\n        pop_estimate_list<-append(pop_estimate_list,(population[j,i]*diabetes_engine[((i*3)-(3-j)),6]))\n        pop_estimate_list<-append(pop_estimate_list,(population[j,i]*diabetes_engine[((i*3)-(3-j)),7]))\n        pop_estimate_list<-append(pop_estimate_list,(population[j,i]*diabetes_engine[((i*3)-(3-j)),8]))\n      }\n    }\n  }else if(pop_estimate==\"low\"){\n    pop_estimate_list<-c()\n    for(i in 1:8){\n      for(j in 1:3){\n        pop_estimate_list<-append(pop_estimate_list,(population[j,i]*diabetes_engine[((i*3)-(3-j)),9]))\n        pop_estimate_list<-append(pop_estimate_list,(population[j,i]*diabetes_engine[((i*3)-(3-j)),10]))\n        pop_estimate_list<-append(pop_estimate_list,(population[j,i]*diabetes_engine[((i*3)-(3-j)),11]))\n        pop_estimate_list<-append(pop_estimate_list,(population[j,i]*diabetes_engine[((i*3)-(3-j)),12]))\n      }\n    }\n  }else\n    pop_estimate_list<-(\"Please Select a population estimate\")\n  return(pop_estimate_list)\n}\n\n\n\n##Create all the different DFs (Low_IGF, High_IGF, IGT, IGF+IGT) first as a giant list (in healthcost_values_diabetes) and then use value_DF_Creator to turn them into seperate DFs---- \n\nvalue_list<-healthcost_values_diabetes(bmore_DF,'high')\n\nvalue_DF_creator<-function(list,number_table){\n  paired_list<-c()\n  for(k in seq(number_table,96,4)){\n    paired_list<-append(paired_list,list[k])\n  }\n  out_DF<-data.frame(matrix(data = paired_list,nrow = 3,ncol = 8))\n  return(out_DF)\n}\n\nlow_IFG<-value_DF_creator(value_list,1)\ncolnames(low_IFG)<-c(\"Hispanic Male\",\"White Male\",\"Black Male\",\"Asian Male\",\"Hispanic Female\",\"White Female\",\"Black Female\",\"Asian Female\")\nhigh_IFG<-value_DF_creator(value_list,2)\ncolnames(high_IFG)<-c(\"Hispanic Male\",\"White Male\",\"Black Male\",\"Asian Male\",\"Hispanic Female\",\"White Female\",\"Black Female\",\"Asian Female\")\nIGT<-value_DF_creator(value_list,3)\ncolnames(IGT)<-c(\"Hispanic Male\",\"White Male\",\"Black Male\",\"Asian Male\",\"Hispanic Female\",\"White Female\",\"Black Female\",\"Asian Female\")\nIFG_IGT<-value_DF_creator(value_list,4)\ncolnames(IFG_IGT)<-c(\"Hispanic Male\",\"White Male\",\"Black Male\",\"Asian Male\",\"Hispanic Female\",\"White Female\",\"Black Female\",\"Asian Female\")\n\npre_diabetic_population<-low_IFG+high_IFG+IGT+IFG_IGT\n\n##take those DFS to create the case analysis tables\n\n##So on the input tab it only graphs the avoidance/ROI for the selected demographics-- so I would only have to build out the case analysis for those... or build out the full case analysis and then subset based on selected inputs\n#Create a function that takes each of our tables (low IGF, High IGF etc) and converts it into a case analysis table\n#Y1-Y4 with and without intervention? #prediabetic population, BMI trajectory, progression rate, normoglycemic, annual normo due to intervention, normo to diabetes progression rate, diabetes incdience, diabetes pervalence\n\n##rate to figure out progression based on table and BMI ######HIS TABLES ONLY LOOK AT THE 2 DIGIT NUMBER, DOESN'T DO THE FULL MATH--- IS THIS RIGHT????\nprogression_rate_func<-function(measure_table,BMI){\n  if(measure_table==\"low_IFG\"){\n    progression_rate<-(.0044*(exp(1)^(.0359*BMI)))\n  }else if(measure_table==\"high_IFG\"){\n    progression_rate<-(.0178*(exp(1)^(.0355*BMI)))\n  }else if(measure_table==\"IFG_IGT\"){\n    progression_rate<-(.026*(exp(1)^(.0354*BMI)))\n  }else if(measure_table=='IGT'){\n    if(BMI<24){\n      progression_rate<-.0262\n    }else if(BMI>=  25 & BMI < 30){\n      progression_rate<-.0463\n    }else{\n      progression_rate<-.0730\n    }\n  }\n  return(progression_rate)\n}\n\n\n##going to have to use this like the value_DF_creator function to create each table (both w and w/o intervention) and then combine them into the pre-diabetic tables\ncase_analysis<-function(measure_table,age,race,gender,pop_estimate,intervention,BMI=34){\n  #subsetting by race\n  if(race=='all races'){\n    measure_table_race<-measure_table\n  }##This isn't the most efficient way to do it, but with my current column names it is how we have to\n  else if(race=='hispanic'){\n    measure_table_race<-measure_table[,c(1,5)]\n  }else if(race=='white'){\n    measure_table_race<-measure_table[,c(2,6)]\n  }else if(race=='black'){\n    measure_table_race<-measure_table[,c(3,7)]\n  }else if(race=='asian'){\n    measure_table_race<-measure_table[,c(4,8)]\n  }\n  #subsetting by gender\n  if(gender=='both genders'){\n    measure_table_gender<-measure_table_race\n  }else if(gender=='male'){\n    measure_table_gender<-measure_table_race[,1]\n  }else if(gender=='female'){\n    measure_table_gender<-measure_table_race[,2]\n  }\n  \n  #subsetting by age\n  if(age=='all ages'){\n    measure_table_final<-measure_table_gender\n  }else if(age=='20-39'){\n    measure_table_final<-measure_table_gender[1,]\n  }else if(age=='40-59'){\n    measure_table_final<-measure_table_gender[2,]\n  }else if(age==\"60+\"){\n    measure_table_final<-measure_table_gender[3,]\n  }\n  \n  #okay so now we have the table that we need to work with in order to create our case analysis table\n  \n  #might have to do outside?  \n  \n  progression_rate<-progression_rate_func(deparse(substitute(measure_table)),BMI)\n  \n  \n  #to get the pre_diabetic table I actually need to do each of the other tables first and then combine in the final... so once the function is complete we'll have to create a w/o and a w/ table for each and then combine to make a prediabetic w/o and w/\n  \n  \n  #Eventually this BMI list will have to be re-written to be a function, but if we just use the standard 34 than it's fine\n  BMI_list<-c(33,32,31.0,30,29)\n  \n  \n  ##works up to here\n  \n  \n  if(intervention=='yes'){\n    #Intervention\n    ##Things I need for this table... PreDiabetic population, BMI Trajectory, progression rate,annual normoglycemic population, normoglycemic to diabetetes progression rate, diabetes incidence, diabetes prevalence\n    ##I don't think this is exactly right, but might give me something close enough to work with for now\n    pre_diabetic_population<-sum(measure_table_final)\n    normoglycemic_population<-pre_diabetic_population*.05\n    BMI<-BMI_list[1]\n    ##have to figure out how to change the BMI and progression rate for each year as it decreases... he uses an input system and a table... I might cheat a little here and just make that list\n    progression_rate<-progression_rate_func(deparse(substitute(measure_table)),BMI)\n    normoglycemic_rate<-progression_rate*.44\n    diabetes_incidence<-((pre_diabetic_population-normoglycemic_population)*progression_rate)+(normoglycemic_population*normoglycemic_rate)\n    diabetes_prevalence<-diabetes_incidence\n    year_1<-c(pre_diabetic_population,BMI,progression_rate,normoglycemic_population,normoglycemic_rate,diabetes_incidence,diabetes_prevalence)\n    for(i in 2:5){\n      pre_diabetic_population<-(pre_diabetic_population*(1.01))-diabetes_incidence-normoglycemic_population\n      normoglycemic_population<-pre_diabetic_population*.05\n      BMI<-BMI_list[i]\n      progression_rate<-progression_rate_func(deparse(substitute(measure_table)),BMI)\n      normoglycemic_rate<-progression_rate*.44\n      diabetes_incidence<-((pre_diabetic_population-normoglycemic_population)*progression_rate)+(normoglycemic_population*normoglycemic_rate)\n      diabetes_prevalence<-diabetes_prevalence+diabetes_incidence\n      assign(paste('year',i,sep = '_'),value=c(pre_diabetic_population,BMI,progression_rate,normoglycemic_population,normoglycemic_rate,diabetes_incidence,diabetes_prevalence))  \n    }\n    output_table<-as.data.frame(matrix(c(year_1,year_2,year_3,year_4,year_5),ncol=5))\n    colnames(output_table)<-c('year 1','year 2','year 3','year 4','year 5')\n    row.names(output_table)<-c('Pre Diabetic Population','BMI','Progression Rate','Normoglycemic Population','Normoglycemic Rate','Diabetes Incidence','Diabetes Prevalence')\n  }else if(intervention=='no'){\n    #non_intervention\n    ##Things I need for this table... PreDiabetic population, BMI Trajectory, progression rate, diabetes incidence, diabetes prevalence\n    pre_diabetic_population<-sum(measure_table_final)\n    progression_rate<-progression_rate_func(deparse(substitute(measure_table)),BMI)\n    diabetes_incidence<-pre_diabetic_population*progression_rate\n    diabetes_prevalence<-diabetes_incidence\n    year_1<-c(pre_diabetic_population,BMI,progression_rate,diabetes_incidence,diabetes_prevalence)\n    for(i in 2:5){\n      pre_diabetic_population<-(pre_diabetic_population*(1.01)-diabetes_incidence)\n      diabetes_incidence<-pre_diabetic_population*progression_rate\n      diabetes_prevalence<-diabetes_prevalence+diabetes_incidence\n      assign(paste('year',i,sep = '_'),value=c(pre_diabetic_population,BMI,progression_rate,diabetes_incidence,diabetes_prevalence))\n    }\n    \n    output_table<-as.data.frame(matrix(c(year_1,year_2,year_3,year_4,year_5),ncol=5))\n    colnames(output_table)<-c('year 1','year 2','year 3','year 4','year 5')\n    row.names(output_table)<-c('Pre Diabetic Population','BMI','Progression Rate','Diabetes Incidence','Diabetes Prevalence')\n  }\n  \n  return(output_table)\n  \n  \n}\n\n#These are for developing, putting them into server.R for interactives \n# low_IFG_no_intervention<-case_analysis(low_IFG,'all ages','all races','both genders','high','no',34)\n# low_IFG_intervention<-case_analysis(low_IFG,'all ages','all races','both genders','high','yes',34)\n# high_IFG_no_intervention<-case_analysis(high_IFG,'all ages','all races','both genders','high','no',34)\n# high_IFG_intervention<-case_analysis(high_IFG,'all ages','all races','both genders','high','yes',34)\n# IGT_no_intervention<-case_analysis(IGT,'all ages','all races','both genders','high','no',34)\n# IGT_intervention<-case_analysis(IGT,'all ages','all races','both genders','high','yes',34)\n# IFG_IGT_no_intervention<-case_analysis(IFG_IGT,'all ages','all races','both genders','high','no',34)\n# IFG_IGT_intervention<-case_analysis(IFG_IGT,'all ages','all races','both genders','high','yes',34)\n\n# pre_diabetic_no_intervention<-(low_IFG_no_intervention+high_IFG_no_intervention+IGT_no_intervention+IFG_IGT_no_intervention)[c(1,4,5),]\n# \n# pre_diabetic_intervention<-(low_IFG_intervention+high_IFG_intervention+IGT_intervention+IFG_IGT_intervention)[c(1,4,6,7),]\n\n\n#Take information from all of these tables and put it into the final ROI table\n\n#What I need... Diabetic Case Avoidance, Commitment adjustusted cases avoidance and cases, healthcare inflation (INPUT EVENTUALLY), cost of treatment (input),total cost of treatment w/,cost of  \nROI_table<-function(pre_diabetic_no_intervention,pre_diabetic_intervention,program_attrition,healthcare_inflation,treatment_cost,intervention_cost){\n  diabetic_case_avoidance<-pre_diabetic_no_intervention[3,1]-pre_diabetic_intervention[4,1]\n  commitment_adjusted_incurred<-diabetic_case_avoidance*(1-program_attrition)\n  commitment_adjusted<-pre_diabetic_intervention[4,1]+(diabetic_case_avoidance-commitment_adjusted_incurred)\n  healthcare_inflation=healthcare_inflation\n  treatment_cost=treatment_cost\n  cost_no_intervention<-treatment_cost*pre_diabetic_no_intervention[3,1]\n  cost_intervention<-treatment_cost*pre_diabetic_intervention[4,1]\n  cost_avoidance<-commitment_adjusted_incurred*treatment_cost\n  #WHY DIVIDE THE PRE-DIABETIC POPULATION BY 5?\n  annual_intervention<-intervention_cost*pre_diabetic_intervention[1,1]\n  cumulative_intervention<-annual_intervention\n  cumulative_ROI<-(cost_avoidance/cumulative_intervention)\n  #do I need to subtract 1?\n  year_1<-c(diabetic_case_avoidance,commitment_adjusted_incurred,commitment_adjusted,healthcare_inflation,treatment_cost,cost_no_intervention,cost_intervention,cost_avoidance,annual_intervention,cumulative_intervention,cumulative_ROI)\n  for(i in 2:5){\n    diabetic_case_avoidance<-pre_diabetic_no_intervention[3,i]-pre_diabetic_intervention[4,i]\n    commitment_adjusted_incurred<-diabetic_case_avoidance*(1-program_attrition)\n    commitment_adjusted<-pre_diabetic_intervention[4,i]+(diabetic_case_avoidance-commitment_adjusted_incurred)\n    healthcare_inflation<-healthcare_inflation\n    treatment_cost<-treatment_cost+(treatment_cost*healthcare_inflation)\n    cost_no_intervention<-treatment_cost*pre_diabetic_no_intervention[3,i]\n    cost_intervention<-treatment_cost*pre_diabetic_intervention[4,i]\n    cost_avoidance<-commitment_adjusted_incurred*treatment_cost\n    #Healthcost currently isn't changing year to year... but it probably should right?\n    ##Healthcost is multiplying the cost as a 5 year cost (so annual figures at 1/5 of the total) but that doesn't make a ton of sense--- it only costs $150 to treat someone for 5 years?\n    annual_intervention<-intervention_cost*pre_diabetic_intervention[1,i]\n    cumulative_intervention<-cumulative_intervention+annual_intervention\n    cumulative_ROI<-(cost_avoidance/cumulative_intervention)\n    assign(paste('year',i,sep = '_'),value=c(diabetic_case_avoidance,commitment_adjusted_incurred,commitment_adjusted,healthcare_inflation,treatment_cost,cost_no_intervention,cost_intervention,cost_avoidance,annual_intervention,cumulative_intervention,cumulative_ROI))\n    \n  }\n  output_table<-as.data.frame(matrix(c(year_1,year_2,year_3,year_4,year_5),ncol=5))\n  colnames(output_table)<-c('year 1','year 2','year 3','year 4','year 5')\n  rownames(output_table)<-c('Case Avoidance','Incurred Case Avoidance','Commitment Adjusted Cases','HealthCare Inflation','Cost per Patient per Year','Cost without intervention','Cost with intervention','Cost Avoidance (incurred)','Annual Intervention Spending','Cummulative Intervention Spending','Cumulative ROI')\n  \n  return(output_table)\n}\n\nROI_final<-ROI_table(pre_diabetic_no_intervention,pre_diabetic_intervention,.4,.03,10000,150)\nrownames(ROI_final) <- str_replace_all(rownames(ROI_final),\"\\\\s+\",\"_\")\n",
    "created" : 1507921851183.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "265|148|302|0|\n",
    "hash" : "2865545844",
    "id" : "53A9A7FF",
    "lastKnownWriteTime" : 1507924732,
    "last_content_update" : 1507924732952,
    "path" : "~/Health_cost_shiny/global.R",
    "project_path" : "global.R",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}